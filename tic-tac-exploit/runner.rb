require_relative './octokitClient'
require_relative './inputValidationError'
require 'yaml'

module TicTacExploit
    class Runner
        METADATA_FILE_PATH = 'tic-tac-exploit/metadata.yml'
        README_PATH = 'README.md'

        def initialize(
            github_token:,
            issue_number:,
            issue_title:,
            repository:,
            user:,
            development: true
          )
          @github_token = github_token
          @repository = repository
          @issue_number = issue_number
          @issue_title = issue_title
          @user = user
          @development = development
          @playerdata 
        end


        def run
            commanddata = ''
            if @issue_title.start_with?('ttestate:')
                command = 'newstate'
                commanddata << @issue_title
                commanddata['ttestate:']='' 
            end
            @playerdata = commanddata.split('|')

            if !isInputOK?
                raise InputValidationError, "INPUT validation failed"
            end

            if didUseTooManyPoints?
                octokit.add_comment(comment: "So you figured it out. You can edit the issue title ;-) However this should not be too easy for you.
                You can only use three data points")
                octokit.add_reaction(reaction: 'hooray')
                octokit.add_reaction(reaction: 'laugh')
                octokit.close_issue 
            else
            acknowledge_issue
            end

        rescue InputValidationError => e
            octokit.add_comment(comment: "Input Validation Failed, did you modify the title, even while we told you not to do it")
            octokit.add_reaction(reaction: 'confused')
            octokit.close_issue
        end

        private
        
        def isInputOK?
            if @playerdata.length() != 9
                octokit.add_comment(comment:"length fail lengh:")
            end
            lenght = 0
            for i in @playerdata do
                lenght += 1
                if i != 1 && i != 0
                    octokit.add_comment(comment: "value i was not OK")
                    return false
                end
            end

            if lenght != 9
                octokit.add_comment(comment:"length fail end")
                return false
            end
            return true
        end

        def didUseTooManyPoints?
            points = 0
            for i in @playerdata do
                if i=1
                    points +=1
                end
            end
            if points > 3
                return true
            else
                return false
            end
        end

        def acknowledge_issue
            octokit.add_label(label: 'tic-tac')
            octokit.add_reaction(reaction: 'eyes')
            octokit.close_issue
        end

        def write_loser
        end

        def write_winnter
        end

        def write_default
        end
        
        def octokit
            @octokit ||= OctokitClient.new(github_token: @github_token, repository: @repository, issue_number: @issue_number)
        end
    end
end